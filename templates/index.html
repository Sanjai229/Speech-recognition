<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Speech-to-Text & Gender Detection</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Speech-to-Text + Gender Detection</h1>
        <p>Click "Start Recording", speak, then "Stop & Analyze".</p>

        <button id="start-btn">Start Recording</button>
        <button id="stop-btn" disabled>Stop & Analyze</button>
        <audio id="audio-preview" controls></audio>

        <h2>Results</h2>
        <div id="transcription"></div>
        <div id="gender"></div>
    </div>

    <script>
    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const audioPreview = document.getElementById("audio-preview");
    const transcriptionDiv = document.getElementById("transcription");
    const genderDiv = document.getElementById("gender");

    startBtn.addEventListener("click", async () => {
        audioChunks = [];
        let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        startBtn.disabled = true;
        stopBtn.disabled = false;
    });

    stopBtn.addEventListener("click", () => {
        mediaRecorder.stop();
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            audioPreview.src = URL.createObjectURL(audioBlob);

            // Send audio to backend
            let formData = new FormData();
            formData.append("audio_data", audioBlob, "recording.wav");

            let response = await fetch("/analyze", { method: "POST", body: formData });
            let result = await response.json();

            transcriptionDiv.innerHTML = "<strong>Transcription:</strong> " + result.transcription;
            genderDiv.innerHTML = "<strong>Gender:</strong> " + result.gender + " (" + result.confidence + "% confidence)";

            startBtn.disabled = false;
            stopBtn.disabled = true;
        };
    });
    </script>
</body>
</html>
